<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Omnipose PyWebView Viewer</title>
    <link rel="stylesheet" href="/static/css/layout.css?v=dev" />
    <link rel="stylesheet" href="/static/css/tools.css?v=dev" />
    <link rel="stylesheet" href="/static/css/controls.css?v=dev" />
    <link rel="stylesheet" href="/static/css/viewer.css?v=dev" />
  </head>
  <body>
    <div id="app">
      <div id="leftPanel" class="side-panel">
        <div class="control history-panel">
          <div class="history-controls" role="group" aria-label="Undo, Redo, and Recenter">
            <button type="button" id="undoButton" class="history-button" aria-label="Undo" disabled>
              <span class="history-icon history-icon-undo" aria-hidden="true"></span>
              <span class="sr-only">Undo</span>
            </button>
            <button type="button" id="redoButton" class="history-button" aria-label="Redo" disabled>
              <span class="history-icon history-icon-redo" aria-hidden="true"></span>
              <span class="sr-only">Redo</span>
            </button>
            <button type="button" id="resetViewButton" class="history-button" aria-label="Recenter view">
              <span class="history-icon history-icon-home" aria-hidden="true"></span>
              <span class="sr-only">Recenter</span>
            </button>
          </div>
        </div>
        <div class="control image-nav-panel">
          <div class="history-controls" role="group" aria-label="Previous and Next Image">
            <button type="button" id="prevImageButton" class="history-button" aria-label="Previous image" disabled>
              <span class="history-icon history-icon-prev" aria-hidden="true"></span>
              <span class="sr-only">Previous image</span>
            </button>
            <button type="button" id="nextImageButton" class="history-button" aria-label="Next image" disabled>
              <span class="history-icon history-icon-next" aria-hidden="true"></span>
              <span class="sr-only">Next image</span>
            </button>
          </div>
        </div>
        <div class="tool-panel">
          <div class="tool-panel-heading">Tools</div>
          <div class="tool-buttons" title="Shortcuts: Cmd/Ctrl+1..4">
            <button type="button" class="tool-stop" data-mode="draw" title="Draw (B)">
              <span class="tool-icon tool-icon-draw" aria-hidden="true"></span>
              <span class="sr-only">Draw</span>
            </button>
            <button type="button" class="tool-stop" data-mode="erase" title="Erase (E)">
              <span class="tool-icon tool-icon-erase" aria-hidden="true"></span>
              <span class="sr-only">Erase</span>
            </button>
            <button type="button" class="tool-stop" data-mode="fill" title="Fill (F)">
              <span class="tool-icon tool-icon-fill" aria-hidden="true"></span>
              <span class="sr-only">Fill</span>
            </button>
            <button type="button" class="tool-stop" data-mode="picker" title="Eyedropper (I)">
              <span class="tool-icon tool-icon-picker" aria-hidden="true"></span>
              <span class="sr-only">Picker</span>
            </button>
          </div>
        </div>
        <div class="brush-panel control">
          <div class="control-heading">Brush Size</div>
          <div class="brush-slider slider-inline">
            <div class="slider" data-slider-id="brushSizeSlider" data-slider-type="single">
              <input type="range" id="brushSizeSlider" min="1" max="25" step="1" value="3" />
            </div>
            <div class="number-field" data-number-id="brushSizeInput">
              <input type="number" id="brushSizeInput" min="1" max="25" step="1" value="3" />
            </div>
          </div>
        </div>
        <div class="label-panel control">
          <label class="label-panel-title" for="labelValueInput">Label</label>
          <div class="label-panel-row label-stepper">
            <button type="button" id="labelStepDown" aria-label="Decrement label">
              <span class="label-icon label-icon-decrement" aria-hidden="true"></span>
              <span class="sr-only">Decrement</span>
            </button>
            <input type="number" id="labelValueInput" min="0" step="1" value="1" />
            <button type="button" id="labelStepUp" aria-label="Increment label">
              <span class="label-icon label-icon-increment" aria-hidden="true"></span>
              <span class="sr-only">Increment</span>
            </button>
          </div>
        </div>
      </div>
      <div id="viewer">
        <canvas id="canvas"></canvas>
        <canvas id="brushPreview"></canvas>
        <div id="dropOverlay" aria-hidden="true">Drop image to load</div>
        <div id="fpsDisplay" aria-hidden="true">FPS: --</div>
      </div>
      <div id="sidebar" class="side-panel">
        <h2 style="margin:0;">Omnipose</h2>
        <div id="imageInfo" class="status"></div>
        <div class="control">
          <label>Intensity Window</label>
          <div class="histogram-surface">
            <canvas id="histogram" class="histogram" width="220" height="80"></canvas>
          </div>
          <div id="histRange" class="status">Window: [0, 255]</div>
        </div>
        <div class="control slider-inline">
          <label for="gamma">&gamma;</label>
          <div class="slider-row">
            <div class="slider" data-slider-id="gamma" data-slider-type="single">
              <input type="range" id="gamma" min="10" max="600" value="100" />
            </div>
            <div class="number-field" data-number-id="gammaInput">
              <input type="number" id="gammaInput" min="0.10" max="6.00" step="0.05" value="1.00" />
            </div>
          </div>
        </div>
        <div class="control">
          <button id="segmentButton">Segment (Omnipose)</button>
          <div id="segmentStatus" class="status"></div>
        </div>
        <div class="control">
          <button id="clearMasksButton" title="Clear all masks (Cmd/Ctrl+X)">Clear Masks</button>
        </div>
        <div class="control">
          <button id="clearCacheButton" title="Clear viewer cache and reload">Clear Cache &amp; Reload</button>
        </div>
        <div class="control slider-inline">
          <label for="maskThresholdSlider">Mask</label>
          <div class="slider-row">
            <div class="slider" data-slider-id="maskThreshold" data-slider-type="single">
              <input type="range" id="maskThresholdSlider" min="-5" max="5" step="0.1" value="-2" />
            </div>
            <div class="number-field" data-number-id="maskThresholdInput">
              <input type="number" id="maskThresholdInput" min="-5" max="5" step="0.1" value="-2.0" />
            </div>
          </div>
        </div>
        <div class="control slider-inline">
          <label for="flowThresholdSlider">Flow</label>
          <div class="slider-row">
            <div class="slider" data-slider-id="flowThreshold" data-slider-type="single">
              <input type="range" id="flowThresholdSlider" min="0" max="5" step="0.1" value="0" />
            </div>
            <div class="number-field" data-number-id="flowThresholdInput">
              <input type="number" id="flowThresholdInput" min="0" max="5" step="0.1" value="0.0" />
            </div>
          </div>
        </div>
        <div class="control toggle-group">
          <label class="toggle">
            <input type="checkbox" id="clusterToggle" checked />
            <span class="toggle-switch"></span>
            <span class="toggle-label">Enable Clustering</span>
          </label>
          <label class="toggle">
            <input type="checkbox" id="affinityToggle" checked />
            <span class="toggle-switch"></span>
            <span class="toggle-label">Affinity Segmentation</span>
          </label>
        </div>
        <div class="control toggle-group" id="overlayControls">
          <label class="toggle">
            <input type="checkbox" id="affinityGraphToggle" />
            <span class="toggle-switch"></span>
            <span class="toggle-label">Affinity Graph</span>
          </label>
          <label class="toggle">
            <input type="checkbox" id="flowOverlayToggle" disabled />
            <span class="toggle-switch"></span>
            <span class="toggle-label">Flow Overlay</span>
          </label>
          <label class="toggle">
            <input type="checkbox" id="distanceOverlayToggle" disabled />
            <span class="toggle-switch"></span>
            <span class="toggle-label">Distance Overlay</span>
          </label>
        </div>
        <div class="control">
          <label for="brushKernelMode">Brush Kernel</label>
          <div class="dropdown" data-dropdown-id="brushKernelMode">
            <select id="brushKernelMode">
              <option value="smooth">Interpolated (continuous)</option>
              <option value="snapped">Snapped (integer)</option>
            </select>
          </div>
        </div>
        <div class="control slider-inline">
          <label for="maskOpacity">Mask Opacity</label>
          <div class="slider-row">
            <div class="slider" data-slider-id="maskOpacity" data-slider-type="single">
              <input type="range" id="maskOpacity" min="0" max="1" step="0.01" value="0.8" />
            </div>
            <div class="number-field" data-number-id="maskOpacityInput">
              <input type="number" id="maskOpacityInput" min="0" max="1" step="0.01" value="0.80" />
            </div>
          </div>
        </div>
        <div class="control toggle-group" id="layerVisibilityControls">
          <label class="toggle">
            <input type="checkbox" id="imageVisibilityToggle" checked />
            <span class="toggle-switch"></span>
            <span class="toggle-label">Show Image</span>
          </label>
          <label class="toggle">
            <input type="checkbox" id="maskVisibilityToggle" checked />
            <span class="toggle-switch"></span>
            <span class="toggle-label">Show Masks</span>
          </label>
        </div>
        <div id="colorMode">Mask Colors: Palette (toggle with 'N')</div>
        <div id="maskLabel">Mask Label: 1</div>
        <div id="toolInfo">Tool: Brush (B=Brush, G=Fill, I=Picker)</div>
        <div id="maskVisibility">Mask Layer: On (toggle with 'M')</div>
        <div id="hoverInfo" class="status">Y: --, X: --, Val: --</div>
        <div class="hint">
          Use B/G/I to switch tools, [ ] to resize brush, digits 0-9 set label. Hold Space to pan, scroll to zoom, W/S to traverse directory.
        </div>
      </div>
    </div>
<script>window.__OMNI_CONFIG__ = {"width": 392, "height": 384, "imageName": "headless-grid.png", "imagePath": "/gui/logo.png", "imageDataUrl": "/gui/logo.png", "colorTable": [], "brushRadius": 6, "sessionId": "headless-grid", "pointerOptions": {}, "enableMaskPipelineV2": true}; window.__OMNI_WEBGL_LOGGING__ = true;</script>
    <script>
    (function(){
      if (window.__omniLogPush) { return; }
      var queue = [];
      var endpoint = '/api/log';
      var maxBatch = 25;
      var flushTimer = null;
      function flush(){
        if (!queue.length) { return; }
        var payload = queue.slice();
        queue.length = 0;
        try {
          fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ entries: payload })
          }).catch(function(){ });
        } catch (err) {
          console.warn('[log] flush failed', err);
        }
      }
      function schedule(){
        if (flushTimer) { return; }
        flushTimer = setTimeout(function(){ flushTimer = null; flush(); }, 300);
      }
      window.__omniLogPush = function(kind, data){
        try {
          queue.push({ kind: kind, data: data, ts: Date.now() });
          if (queue.length >= maxBatch) {
            if (flushTimer) { clearTimeout(flushTimer); flushTimer = null; }
            flush();
          } else {
            schedule();
          }
        } catch (err) {
          console.warn('[log] push failed', err);
        }
      };
      window.addEventListener('error', function(evt){
        window.__omniLogPush('JS_ERROR', {
          message: evt.message || '',
          filename: evt.filename || '',
          lineno: evt.lineno || 0,
          colno: evt.colno || 0,
          stack: evt.error && evt.error.stack ? String(evt.error.stack) : ''
        });
      });
    })();
    </script>
    <!-- IMPORTANT: Viewer scripts must remain classic scripts in this order. Switching to type="module" breaks PyWebView image loading. -->
    <script src="/static/js/pointer-state.js?v=dev"></script>
    <script src="/static/js/logging.js?v=dev"></script>
    <script src="/static/js/history.js?v=dev"></script>
    <script src="/static/js/brush.js?v=dev"></script>
    <script src="/static/js/painting.js?v=dev"></script>
    <script src="/static/js/interactions.js?v=dev"></script>
    <script src="/static/app.js?v=dev"></script>
  </body>
</html>
